---
import BlogPostLayout from '@/layouts/BlogPostLayout.astro';
import { getCollection, render } from 'astro:content';
import { getSlugFromId, getBlogSnapshots } from '@/lib/blog';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const snapshots = await getCollection('blogSnapshots');

  // Generate paths for main posts
  const postPaths = posts.map((post) => ({
    params: { slug: getSlugFromId(post.id) },
    props: { post, isSnapshot: false },
  }));

  // Generate paths for snapshot versions
  const snapshotPaths = snapshots.map((snapshot) => {
    const slug = snapshot.id.split('/')[0];
    const version = snapshot.id.split('/')[1].replace('.snapshot.mdx', '');
    return {
      params: { slug: `${slug}/${version}` },
      props: { post: snapshot, isSnapshot: true },
    };
  });

  return [...postPaths, ...snapshotPaths];
}

const { post, isSnapshot } = Astro.props;
const { Content } = await render(post);
const slug = isSnapshot
  ? post.id.split('/')[0]
  : getSlugFromId(post.id);
const snapshots = await getBlogSnapshots(slug);
---

<BlogPostLayout
  title={post.data.title}
  abstract={post.data.abstract}
  publishedAt={post.data.publishedAt}
  updatedAt={isSnapshot ? new Date(post.data.snapshotDate) : post.data.updatedAt}
  tags={post.data.tags}
  seoTitle={post.data.seoTitle}
  seoDescription={post.data.seoDescription}
  ogImage={post.data.ogImage}
  snapshots={snapshots}
  slug={slug}
  isSnapshot={isSnapshot}
  snapshotDate={isSnapshot ? new Date(post.data.snapshotDate) : undefined}
>
  <Content />
</BlogPostLayout>
