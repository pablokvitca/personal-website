---
import BaseLayout from './BaseLayout.astro';
import ToolingBadges from '@/components/ui/ToolingBadges.astro';
import ProjectBadges from '@/components/projects/ProjectBadges.astro';
import TableOfContents from '@/components/ui/TableOfContents.astro';
import VersionHistoryDropdown from '@/components/ui/VersionHistoryDropdown.astro';
import Prose from '@/components/ui/starwind/prose';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/starwind/alert';
import HistoryIcon from '@tabler/icons/outline/history.svg';
import ExternalLinkIcon from '@tabler/icons/outline/external-link.svg';
import GithubIcon from '@tabler/icons/outline/brand-github.svg';
import GlobeIcon from '@tabler/icons/outline/globe.svg';
import FileTextIcon from '@tabler/icons/outline/file-text.svg';
import { formatDate } from '@/lib/blog';
import type { Heading } from '@/lib/blog';

interface SnapshotData {
  id: string;
  data: {
    snapshotDate?: string | Date | undefined;
  };
}

interface Props {
  title: string;
  description: string;
  tags: string[];
  status: 'active' | 'completed' | 'archived';
  startDate?: Date;
  endDate?: Date;
  links?: {
    github?: string;
    demo?: string;
    docs?: string;
  };
  snapshots?: SnapshotData[];
  slug?: string;
  isSnapshot?: boolean;
  snapshotDate?: Date;
  headings?: Heading[];
  tocMaxDepth?: number;
}

const {
  title,
  description,
  tags,
  status,
  startDate: _startDate,
  endDate: _endDate,
  links,
  snapshots = [],
  slug = '',
  isSnapshot = false,
  snapshotDate,
  headings = [],
  tocMaxDepth = 3,
} = Astro.props;

// Dates available for future use
void _startDate;
void _endDate;

const statusLabels = {
  active: 'Active',
  completed: 'Completed',
  archived: 'Archived',
};

const totalVersions = snapshots.length + 1;
const currentVersion = isSnapshot
  ? snapshots.findIndex(
      (s) => new Date(s.data.snapshotDate ?? 0).getTime() === snapshotDate?.getTime()
    ) + 1
  : totalVersions;

const snapshotData = snapshots.map((snapshot) => {
  const filename = snapshot.id.split('/')[1];
  const timestamp = filename.replace('snapshot', '');
  return {
    url: `/projects/${slug}/snapshot/${timestamp}`,
    date: new Date(snapshot.data.snapshotDate ?? 0),
  };
});
---

<BaseLayout title={`${title} - Projects - Pablo Kvitca`} description={description}>
  <div class="lg:grid lg:grid-cols-[256px_1fr] lg:gap-8 max-w-7xl mx-auto">
    <TableOfContents headings={headings} maxDepth={tocMaxDepth} title={title} />

    <article class="max-w-3xl">
      <header class="mb-8">
        <div class="flex items-start justify-between mb-4">
          <h1 class="text-4xl font-bold">{title}</h1>
          <span
            class:list={[
              'text-sm px-3 py-1 rounded-full',
              status === 'active' && 'bg-green-100 text-green-800',
              status === 'completed' && 'bg-blue-100 text-blue-800',
              status === 'archived' && 'bg-gray-100 text-gray-800',
            ]}
          >
            {statusLabels[status]}
          </span>
        </div>
        <p class="text-xl text-muted-foreground mb-4">{description}</p>
        <ToolingBadges tags={tags} />

        {
          snapshots.length > 0 && (
            <div class="text-sm text-muted-foreground mt-4">
              <VersionHistoryDropdown
                currentVersion={currentVersion}
                totalVersions={totalVersions}
                snapshots={snapshotData}
                slug={slug}
                basePath="/projects"
              />
            </div>
          )
        }

        {
          links && (
            <>
              <div class="mt-4">
                <ProjectBadges links={links} />
              </div>

              <div class="flex flex-wrap gap-2 mt-3">
                {links.github && (
                  <a
                    href={links.github}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-secondary text-secondary-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
                  >
                    <GithubIcon class="size-4" />
                    GitHub
                    <ExternalLinkIcon class="size-3.5 opacity-60" />
                  </a>
                )}
                {links.demo && (
                  <a
                    href={links.demo}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-secondary text-secondary-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
                  >
                    <GlobeIcon class="size-4" />
                    Live Demo
                    <ExternalLinkIcon class="size-3.5 opacity-60" />
                  </a>
                )}
                {links.docs && (
                  <a
                    href={links.docs}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-md border border-border bg-secondary text-secondary-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
                  >
                    <FileTextIcon class="size-4" />
                    Documentation
                    <ExternalLinkIcon class="size-3.5 opacity-60" />
                  </a>
                )}
              </div>
            </>
          )
        }
      </header>
      {isSnapshot && snapshotDate && (
        <Alert variant="secondary" class="mb-8">
          <AlertTitle>
            <HistoryIcon class="w-5 h-5" />
            Historical Version
          </AlertTitle>
          <AlertDescription>
            You are viewing a historical version of this project from {formatDate(snapshotDate)}.{' '}
            <a href={`/projects/${slug}`} class="text-primary hover:underline">
              View current version
            </a>
          </AlertDescription>
        </Alert>
      )}
      <Prose class="max-w-none">
        <slot />
      </Prose>
    </article>
  </div>
</BaseLayout>
