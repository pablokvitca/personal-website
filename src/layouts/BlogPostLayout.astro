---
import BaseLayout from './BaseLayout.astro';
import TagBadge from '@/components/blog/TagBadge.astro';
import Prose from '@/components/ui/starwind/prose';
import VersionHistoryDropdown from '@/components/blog/VersionHistoryDropdown.astro';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/starwind/alert';
import HistoryIcon from '@tabler/icons/outline/history.svg';
import { formatDate } from '@/lib/blog';

interface SnapshotData {
  id: string;
  data: {
    snapshotDate: string | Date;
  };
}

interface Props {
  title: string;
  abstract: string;
  publishedAt: Date;
  updatedAt?: Date;
  tags: string[];
  seoTitle?: string;
  seoDescription?: string;
  ogImage?: string;
  snapshots?: SnapshotData[];
  slug?: string;
  isSnapshot?: boolean;
  snapshotDate?: Date;
}

const {
  title,
  abstract,
  publishedAt,
  updatedAt,
  tags,
  seoTitle,
  seoDescription,
  ogImage,
  snapshots = [],
  slug = '',
  isSnapshot = false,
  snapshotDate,
} = Astro.props;

const totalVersions = snapshots.length + 1;
const currentVersion = isSnapshot
  ? snapshots.findIndex((s) => new Date(s.data.snapshotDate).getTime() === snapshotDate?.getTime()) + 1
  : totalVersions;

const snapshotData = snapshots.map((snapshot) => {
  // Astro glob loader converts "2026-01-25-17-58.snapshot.mdx" ID to "2026-01-25-17-58snapshot"
  const filename = snapshot.id.split('/')[1];
  const timestamp = filename.replace('snapshot', '');
  return {
    url: `/blog/${slug}/snapshot/${timestamp}`,
    date: new Date(snapshot.data.snapshotDate),
  };
});
---

<BaseLayout
  title={seoTitle ?? `${title} - Pablo Kvitca`}
  description={seoDescription ?? abstract}
  ogImage={ogImage}
  article={{
    publishedTime: publishedAt,
    modifiedTime: updatedAt,
    tags,
  }}
>
  <article class="max-w-3xl mx-auto">
    <header class="mb-8">
      <h1 class="text-4xl font-bold mb-4">{title}</h1>
      <p class="text-xl text-muted-foreground mb-4">{abstract}</p>
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.map((tag) => <TagBadge tag={tag} size="md" />)}
      </div>
      <div class="flex items-center gap-4 text-sm text-muted-foreground">
        <time datetime={publishedAt.toISOString()}>
          First Published: {formatDate(publishedAt)}
        </time>
        {
          updatedAt && (
            <div class="flex items-center gap-2">
              <time datetime={updatedAt.toISOString()}>
                Last Updated: {formatDate(updatedAt)}
              </time>
              {snapshots.length > 0 && (
                <span>
                  (
                  <VersionHistoryDropdown
                    currentVersion={currentVersion}
                    totalVersions={totalVersions}
                    snapshots={snapshotData}
                    slug={slug}
                  />
                  )
                </span>
              )}
            </div>
          )
        }
      </div>
    </header>
    {isSnapshot && snapshotDate && (
      <Alert variant="secondary" class="mb-8">
        <AlertTitle>
          <HistoryIcon class="w-5 h-5" />
          Historical Version
        </AlertTitle>
        <AlertDescription>
          You are viewing a historical version of this post from {formatDate(snapshotDate)}.{' '}
          <a href={`/blog/${slug}`} class="text-primary hover:underline">
            View current version
          </a>
        </AlertDescription>
      </Alert>
    )}
    <Prose class="max-w-none">
      <slot />
    </Prose>
  </article>
</BaseLayout>
