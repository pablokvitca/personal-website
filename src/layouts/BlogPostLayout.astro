---
import BaseLayout from './BaseLayout.astro';
import TagBadge from '@/components/ui/TagBadge.astro';
import ToolingBadges from '@/components/ui/ToolingBadges.astro';
import Prose from '@/components/ui/starwind/prose';
import VersionHistoryDropdown from '@/components/ui/VersionHistoryDropdown.astro';
import TableOfContents from '@/components/ui/TableOfContents.astro';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/starwind/alert';
import HistoryIcon from '@tabler/icons/outline/history.svg';
import { formatDate } from '@/lib/blog';
import type { Heading } from '@/lib/blog';
import { getNonTechnologyTags } from '@/lib/tags';

interface SnapshotData {
  id: string;
  data: {
    snapshotDate: string | Date;
  };
}

interface Props {
  title: string;
  abstract: string;
  publishedAt: Date;
  updatedAt?: Date;
  tags: string[];
  seoTitle?: string;
  seoDescription?: string;
  ogImage?: string;
  snapshots?: SnapshotData[];
  slug?: string;
  isSnapshot?: boolean;
  snapshotDate?: Date;
  headings?: Heading[];
  tocMaxDepth?: number;
}

const {
  title,
  abstract,
  publishedAt,
  updatedAt,
  tags,
  seoTitle,
  seoDescription,
  ogImage,
  snapshots = [],
  slug = '',
  isSnapshot = false,
  snapshotDate,
  headings = [],
  tocMaxDepth = 3,
} = Astro.props;

const nonTechTags = getNonTechnologyTags(tags);

const totalVersions = snapshots.length + 1;
const currentVersion = isSnapshot
  ? snapshots.findIndex((s) => new Date(s.data.snapshotDate).getTime() === snapshotDate?.getTime()) + 1
  : totalVersions;

const snapshotData = snapshots.map((snapshot) => {
  // Astro glob loader converts "2026-01-25-17-58.snapshot.mdx" ID to "2026-01-25-17-58snapshot"
  const filename = snapshot.id.split('/')[1];
  const timestamp = filename.replace('snapshot', '');
  return {
    url: `/blog/${slug}/snapshot/${timestamp}`,
    date: new Date(snapshot.data.snapshotDate),
  };
});
---

<BaseLayout
  title={seoTitle ?? `${title} - Pablo Kvitca`}
  description={seoDescription ?? abstract}
  ogImage={ogImage}
  article={{
    publishedTime: publishedAt,
    modifiedTime: updatedAt,
    tags,
  }}
>
  <div class="lg:grid lg:grid-cols-[256px_1fr] lg:gap-8 max-w-7xl mx-auto">
    <TableOfContents headings={headings} maxDepth={tocMaxDepth} title={title} />

    <article class="max-w-3xl">
      <header class="mb-8">
        <h1 class="text-4xl font-bold mb-4">{title}</h1>
        <p class="text-xl text-muted-foreground mb-4">{abstract}</p>
        <div class={nonTechTags.length > 0 ? 'mb-2' : 'mb-4'}>
          <ToolingBadges tags={tags} />
        </div>
        {nonTechTags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-4">
            {nonTechTags.map((tag) => <TagBadge tag={tag.raw} size="md" />)}
          </div>
        )}
        <div class="text-sm text-muted-foreground">
          {snapshots.length > 0 ? (
            <span>
              <time datetime={publishedAt.toISOString()}>
                First Published: {formatDate(publishedAt)}
              </time>
              {" - "}
              {updatedAt && (
                <>
                  <time datetime={updatedAt.toISOString()}>
                    Last Updated: {formatDate(updatedAt)}
                  </time>
                  {" - "}
                </>
              )}
              <VersionHistoryDropdown
                currentVersion={currentVersion}
                totalVersions={totalVersions}
                snapshots={snapshotData}
                slug={slug}
                basePath="/blog"
              />
            </span>
          ) : (
            <time datetime={publishedAt.toISOString()}>
              Published on {formatDate(publishedAt)}
            </time>
          )}
        </div>
      </header>
      {isSnapshot && snapshotDate && (
        <Alert variant="secondary" class="mb-8">
          <AlertTitle>
            <HistoryIcon class="w-5 h-5" />
            Historical Version
          </AlertTitle>
          <AlertDescription>
            You are viewing a historical version of this post from {formatDate(snapshotDate)}.{' '}
            <a href={`/blog/${slug}`} class="text-primary hover:underline">
              View current version
            </a>
          </AlertDescription>
        </Alert>
      )}
      <Prose class="max-w-none">
        <slot />
      </Prose>
    </article>
  </div>
</BaseLayout>
