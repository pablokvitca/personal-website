name: Deploy Preview

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  contents: write
  issues: write

jobs:
  # ---------------------------------------------------------------------------
  # Triggered by "/deploy" comment on a PR â†’ creates preview/<head-branch>
  # ---------------------------------------------------------------------------
  create-preview:
    if: >
      github.event_name == 'issue_comment'
      && github.event.action == 'created'
      && github.event.issue.pull_request != null
      && contains(github.event.comment.body, '/deploy')
    runs-on: ubuntu-latest

    steps:
      - name: Verify commenter has write access
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login,
            });
            if (!['admin', 'maintain', 'write'].includes(data.permission)) {
              core.setFailed('Commenter does not have write access.');
            }

      - name: Get PR head branch and SHA
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: json
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
            });
            return { head_ref: pr.head.ref, head_sha: pr.head.sha };

      - name: Create or update preview branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const headRef = '${{ steps.pr-info.outputs.result }}';
            const { head_ref, head_sha } = JSON.parse(headRef);
            const previewBranch = `preview/${head_ref}`;

            try {
              // Try to update existing ref
              await github.rest.git.updateRef({
                owner, repo,
                ref: `heads/${previewBranch}`,
                sha: head_sha,
                force: true,
              });
              core.info(`Updated existing branch ${previewBranch}`);
            } catch {
              // Doesn't exist yet â€” create it
              await github.rest.git.createRef({
                owner, repo,
                ref: `refs/heads/${previewBranch}`,
                sha: head_sha,
              });
              core.info(`Created new branch ${previewBranch}`);
            }

      - name: Post preview URL comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_PAT }}
          script: |
            const { head_ref } = JSON.parse('${{ steps.pr-info.outputs.result }}');
            // Cloudflare Pages preview URL uses the branch name with slashes â†’ hyphens
            const slug = `preview-${head_ref}`.replace(/\//g, '-');
            const url  = `https://${slug}.pablokvitca-website.pages.dev`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸš€ **Preview deployment triggered**\n\nBranch \`preview/${head_ref}\` has been created. Once Cloudflare finishes building, it will be available at:\n\n${url}\n\n> It may take a minute or two for the URL to go live.`,
            });

  # ---------------------------------------------------------------------------
  # Triggered when the PR is closed â†’ deletes the preview/<head-branch>
  # ---------------------------------------------------------------------------
  cleanup-preview:
    if: >
      github.event_name == 'pull_request'
      && github.event.action == 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Delete preview branch if it exists
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const headRef = context.payload.pull_request.head.ref;
            const previewBranch = `heads/preview/${headRef}`;

            try {
              await github.rest.git.deleteRef({ owner, repo, ref: previewBranch });
              core.info(`Deleted branch preview/${headRef}`);
            } catch (e) {
              core.info(`No preview branch to clean up (preview/${headRef})`);
            }
